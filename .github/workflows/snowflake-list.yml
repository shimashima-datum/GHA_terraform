name: Snowflake list tables (manual)

on:
  workflow_dispatch:
    inputs: 
      database:
        description: "Snowflake database name"
        type: string
        default: "TAKUMA_NISHIZUKA_DB"
      schema:
        description: "Target schema (use % for all)"
        type: string
        default: "PUBLIC"
      warehouse:
        description: "Warehouse name"
        type: string
        default: "TAKUMA_NISHIZUKA_WH"
  push:
    branches:
      - main

permissions:
  contents: read

env:
  # --- Secrets（GitHub Secrets に登録しておく） ---
  SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}   # 例: ar29333.ap-northeast-1.aws
  SNOWFLAKE_USER:    ${{ secrets.SNOWFLAKE_USER }}      # 例: TAKUMA.NISHIZUKA@DATUMSTUDIO.JP
  SNOWFLAKE_ROLE:    ${{ secrets.SNOWFLAKE_ROLE }}      # 例: SYSADMIN（任意）
  # base64 エンコードした p8 秘密鍵
  SNOWFLAKE_PRIVATE_KEY_B64: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_B64 }}

  # “入力相当” の環境変数（push の場合はデフォルトにフォールバック）
  INPUT_DATABASE:  ${{ github.event.inputs.database  || 'TAKUMA_NISHIZUKA_DB' }}
  INPUT_SCHEMA:    ${{ github.event.inputs.schema    || 'PUBLIC' }}
  INPUT_WAREHOUSE: ${{ github.event.inputs.warehouse || 'TAKUMA_NISHIZUKA_WH' }}

jobs:
  list-tables:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-connector-python cryptography

      - name: Restore private key (PEM)
        shell: bash
        run: |
          echo "$SNOWFLAKE_PRIVATE_KEY_B64" | base64 -d > private_key.p8
          chmod 600 private_key.p8

      - name: Run tools/snowflake_list.py
        env:
          # 入力値（push でも上の env のデフォルトが入る）
          SNOWFLAKE_DATABASE:      ${{ env.INPUT_DATABASE }}
          SNOWFLAKE_SCHEMA_LIKE:   ${{ env.INPUT_SCHEMA }}
          SNOWFLAKE_WAREHOUSE:     ${{ env.INPUT_WAREHOUSE }}
          # 復元した鍵のパス
          SNOWFLAKE_PRIVATE_KEY_PATH: private_key.p8
        run: |
          python tools/snowflake_list.py

      - name: Upload result (tables.csv)
        uses: actions/upload-artifact@v4
        with:
          name: tables
          path: tables.csv
